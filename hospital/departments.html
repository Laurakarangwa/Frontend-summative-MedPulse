<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Department Management - MedPulse</title>
  <link rel="stylesheet" href="hospital.css" />
</head>
<body>
  <nav class="navbar">
    <div class="nav-container">
      <h1 class="nav-brand">MedPulse</h1>
      <div class="nav-links">
        <a href="dashboard.html">Dashboard</a>
        <a href="change-password.html">Change Password</a>
        <a href="#" onclick="logout()">Logout</a>
      </div>
    </div>
  </nav>

  <div class="dashboard-container">
    <div class="page-header">
      <h2>Department Management</h2>
      <button class="btn-primary" onclick="showAddDepartmentForm()">+ Add New Department</button>
    </div>

    <!-- Add/Edit Department Form -->
    <div id="department-form-section" class="form-section" style="display: none;">
      <h3 id="form-title">Add New Department</h3>
      <form id="department-form">
        <input type="hidden" id="department-id" />
        <div class="form-group">
          <label for="department-name">Department Name</label>
          <input type="text" id="department-name" required />
        </div>
        <div class="form-group">
          <label for="department-description">Description</label>
          <textarea id="department-description" rows="3"></textarea>
        </div>
        <div class="form-group">
          <label for="department-head">Department Head (Optional)</label>
          <input type="text" id="department-head" />
        </div>
        <div class="form-actions">
          <button type="submit" class="submit-btn">Save Department</button>
          <button type="button" class="btn-secondary" onclick="hideDepartmentForm()">Cancel</button>
        </div>
      </form>
    </div>

    <!-- Departments List -->
    <div class="table-section">
      <h3>Departments List</h3>
      <div class="table-container">
        <table class="data-table">
          <thead>
            <tr>
              <th>Department Name</th>
              <th>Description</th>
              <th>Department Head</th>
              <th>Number of Doctors</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="departments-list">
            <!-- Departments will be loaded here -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    let departments = JSON.parse(localStorage.getItem('departments')) || [];
    let editingId = null;

  
    // Load departments on page load
    window.addEventListener('DOMContentLoaded', () => {
      loadDepartments();
    });

    function loadDepartments() {
      const tbody = document.getElementById('departments-list');
      if (departments.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No departments found. Add your first department.</td></tr>';
        return;
      }

      tbody.innerHTML = departments.map(dept => {
        const doctorCount = getDoctorsByDepartment(dept.id).length;
        return `
          <tr>
            <td>${dept.name}</td>
            <td>${dept.description || 'N/A'}</td>
            <td>${dept.head || 'N/A'}</td>
            <td>${doctorCount}</td>
            <td>
              <button class="btn-edit" onclick="editDepartment('${dept.id}')">Edit</button>
              <button class="btn-delete" onclick="deleteDepartment('${dept.id}')">Delete</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function getDoctorsByDepartment(deptId) {
      const doctors = JSON.parse(localStorage.getItem('doctors')) || [];
      return doctors.filter(doc => doc.departmentId === deptId);
    }

    function showAddDepartmentForm() {
      editingId = null;
      document.getElementById('form-title').textContent = 'Add New Department';
      document.getElementById('department-form').reset();
      document.getElementById('department-id').value = '';
      document.getElementById('department-form-section').style.display = 'block';
    }

    function hideDepartmentForm() {
      document.getElementById('department-form-section').style.display = 'none';
      editingId = null;
    }

    function editDepartment(id) {
      const dept = departments.find(d => d.id === id);
      if (!dept) return;

      editingId = id;
      document.getElementById('form-title').textContent = 'Edit Department';
      document.getElementById('department-id').value = dept.id;
      document.getElementById('department-name').value = dept.name;
      document.getElementById('department-description').value = dept.description || '';
      document.getElementById('department-head').value = dept.head || '';
      document.getElementById('department-form-section').style.display = 'block';
    }

    function deleteDepartment(id) {
      if (!confirm('Are you sure you want to delete this department?')) return;

      // Check if department has doctors
      const doctors = getDoctorsByDepartment(id);
      if (doctors.length > 0) {
        alert(`Cannot delete department. ${doctors.length} doctor(s) are assigned to this department.`);
        return;
      }

      departments = departments.filter(d => d.id !== id);
      localStorage.setItem('departments', JSON.stringify(departments));
      addAuditLog('Department deleted', `Department ID: ${id}`);
      loadDepartments();
    }

    document.getElementById('department-form').addEventListener('submit', (e) => {
      e.preventDefault();

      const name = document.getElementById('department-name').value;
      const description = document.getElementById('department-description').value;
      const head = document.getElementById('department-head').value;

      if (editingId) {
        // Update existing department
        const index = departments.findIndex(d => d.id === editingId);
        if (index !== -1) {
          departments[index] = { ...departments[index], name, description, head };
          addAuditLog('Department updated', `Department: ${name}`);
        }
      } else {
        // Add new department
        const newDept = {
          id: 'DEPT-' + Date.now(),
          name,
          description,
          head,
          createdAt: new Date().toISOString()
        };
        departments.push(newDept);
        addAuditLog('Department created', `Department: ${name}`);
      }

      localStorage.setItem('departments', JSON.stringify(departments));
      loadDepartments();
      hideDepartmentForm();
      alert('Department saved successfully!');
    });

    function addAuditLog(action, details) {
      const logs = JSON.parse(localStorage.getItem('auditLogs')) || [];
      logs.unshift({
        id: 'LOG-' + Date.now(),
        action,
        details,
        user: localStorage.getItem('hospitalName') || 'Hospital Admin',
        timestamp: new Date().toISOString()
      });
      localStorage.setItem('auditLogs', JSON.stringify(logs));
    }

    function logout() {
      if (confirm('Are you sure you want to logout?')) {
        localStorage.removeItem('hospitalLoggedIn');
        localStorage.removeItem('hospitalName');
        window.location.href = '../index.html';
      }
    }
  </script>
</body>
</html>

