<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Working Hours & Shifts - MedPulse</title>
  <link rel="stylesheet" href="hospital.css" />
</head>
<body>
  <nav class="navbar">
    <div class="nav-container">
      <h1 class="nav-brand">MedPulse</h1>
      <div class="nav-links">
        <a href="dashboard.html">Dashboard</a>
        <a href="change-password.html">Change Password</a>
        <a href="#" onclick="logout()">Logout</a>
      </div>
    </div>
  </nav>

  <div class="dashboard-container">
    <div class="page-header">
      <h2>Working Hours & Shifts Management</h2>
      <button class="btn-primary" onclick="showAddShiftForm()">+ Add Shift Schedule</button>
    </div>

    <!-- Add/Edit Shift Form -->
    <div id="shift-form-section" class="form-section" style="display: none;">
      <h3 id="form-title">Add Shift Schedule</h3>
      <form id="shift-form">
        <input type="hidden" id="shift-id" />
        <div class="form-group">
          <label for="shift-department">Department</label>
          <select id="shift-department" required>
            <option value="">Select Department...</option>
          </select>
        </div>
        <div class="form-group">
          <label for="shift-day">Day of Week</label>
          <select id="shift-day" required>
            <option value="">Select Day...</option>
            <option value="Monday">Monday</option>
            <option value="Tuesday">Tuesday</option>
            <option value="Wednesday">Wednesday</option>
            <option value="Thursday">Thursday</option>
            <option value="Friday">Friday</option>
            <option value="Saturday">Saturday</option>
            <option value="Sunday">Sunday</option>
          </select>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="shift-start">Start Time</label>
            <input type="time" id="shift-start" required />
          </div>
          <div class="form-group">
            <label for="shift-end">End Time</label>
            <input type="time" id="shift-end" required />
          </div>
        </div>
        <div class="form-group">
          <label for="shift-doctors">Assign Doctors (Optional)</label>
          <select id="shift-doctors" multiple>
          </select>
          <small>Hold Ctrl/Cmd to select multiple doctors</small>
        </div>
        <div class="form-actions">
          <button type="submit" class="submit-btn">Save Shift</button>
          <button type="button" class="btn-secondary" onclick="hideShiftForm()">Cancel</button>
        </div>
      </form>
    </div>

    <!-- Shifts List -->
    <div class="table-section">
      <h3>Shift Schedules</h3>
      <div class="table-container">
        <table class="data-table">
          <thead>
            <tr>
              <th>Department</th>
              <th>Day</th>
              <th>Start Time</th>
              <th>End Time</th>
              <th>Assigned Doctors</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="shifts-list">
            <!-- Shifts will be loaded here -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    let shifts = JSON.parse(localStorage.getItem('shifts')) || [];
    let editingId = null;

    window.addEventListener('DOMContentLoaded', () => {
      loadDepartments();
      loadDoctors();
      loadShifts();
    });

    function loadDepartments() {
      const departments = JSON.parse(localStorage.getItem('departments')) || [];
      const select = document.getElementById('shift-department');
      select.innerHTML = '<option value="">Select Department...</option>';
      departments.forEach(dept => {
        const option = document.createElement('option');
        option.value = dept.id;
        option.textContent = dept.name;
        select.appendChild(option);
      });
    }

    function loadDoctors() {
      const doctors = JSON.parse(localStorage.getItem('doctors')) || [];
      const select = document.getElementById('shift-doctors');
      select.innerHTML = '';
      doctors.forEach(doctor => {
        const option = document.createElement('option');
        option.value = doctor.id;
        option.textContent = doctor.name || doctor.doctorName;
        select.appendChild(option);
      });
    }

    function loadShifts() {
      const tbody = document.getElementById('shifts-list');
      if (shifts.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No shifts scheduled. Add your first shift.</td></tr>';
        return;
      }

      const departments = JSON.parse(localStorage.getItem('departments')) || [];
      const doctors = JSON.parse(localStorage.getItem('doctors')) || [];

      tbody.innerHTML = shifts.map(shift => {
        const dept = departments.find(d => d.id === shift.departmentId);
        const assignedDoctors = shift.doctorIds ? shift.doctorIds.map(id => {
          const doc = doctors.find(d => d.id === id);
          return doc ? (doc.name || doc.doctorName) : 'Unknown';
        }).join(', ') : 'None';
        
        return `
          <tr>
            <td>${dept ? dept.name : 'Unknown'}</td>
            <td>${shift.day}</td>
            <td>${shift.startTime}</td>
            <td>${shift.endTime}</td>
            <td>${assignedDoctors}</td>
            <td>
              <button class="btn-edit" onclick="editShift('${shift.id}')">Edit</button>
              <button class="btn-delete" onclick="deleteShift('${shift.id}')">Delete</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function showAddShiftForm() {
      editingId = null;
      document.getElementById('form-title').textContent = 'Add Shift Schedule';
      document.getElementById('shift-form').reset();
      document.getElementById('shift-id').value = '';
      document.getElementById('shift-form-section').style.display = 'block';
    }

    function hideShiftForm() {
      document.getElementById('shift-form-section').style.display = 'none';
      editingId = null;
    }

    function editShift(id) {
      const shift = shifts.find(s => s.id === id);
      if (!shift) return;

      editingId = id;
      document.getElementById('form-title').textContent = 'Edit Shift Schedule';
      document.getElementById('shift-id').value = shift.id;
      document.getElementById('shift-department').value = shift.departmentId;
      document.getElementById('shift-day').value = shift.day;
      document.getElementById('shift-start').value = shift.startTime;
      document.getElementById('shift-end').value = shift.endTime;
      
      if (shift.doctorIds) {
        Array.from(document.getElementById('shift-doctors').options).forEach(option => {
          option.selected = shift.doctorIds.includes(option.value);
        });
      }
      
      document.getElementById('shift-form-section').style.display = 'block';
    }

    function deleteShift(id) {
      if (!confirm('Are you sure you want to delete this shift?')) return;
      shifts = shifts.filter(s => s.id !== id);
      localStorage.setItem('shifts', JSON.stringify(shifts));
      addAuditLog('Shift deleted', `Shift ID: ${id}`);
      loadShifts();
    }

    document.getElementById('shift-form').addEventListener('submit', (e) => {
      e.preventDefault();

      const departmentId = document.getElementById('shift-department').value;
      const day = document.getElementById('shift-day').value;
      const startTime = document.getElementById('shift-start').value;
      const endTime = document.getElementById('shift-end').value;
      const doctorIds = Array.from(document.getElementById('shift-doctors').selectedOptions).map(opt => opt.value);

      if (editingId) {
        const index = shifts.findIndex(s => s.id === editingId);
        if (index !== -1) {
          shifts[index] = { ...shifts[index], departmentId, day, startTime, endTime, doctorIds };
          addAuditLog('Shift updated', `Department: ${departmentId}, Day: ${day}`);
        }
      } else {
        const newShift = {
          id: 'SHIFT-' + Date.now(),
          departmentId,
          day,
          startTime,
          endTime,
          doctorIds,
          createdAt: new Date().toISOString()
        };
        shifts.push(newShift);
        addAuditLog('Shift created', `Department: ${departmentId}, Day: ${day}`);
      }

      localStorage.setItem('shifts', JSON.stringify(shifts));
      loadShifts();
      hideShiftForm();
      alert('Shift saved successfully!');
    });

    function addAuditLog(action, details) {
      const logs = JSON.parse(localStorage.getItem('auditLogs')) || [];
      logs.unshift({
        id: 'LOG-' + Date.now(),
        action,
        details,
        user: localStorage.getItem('hospitalName') || 'Hospital Admin',
        timestamp: new Date().toISOString()
      });
      localStorage.setItem('auditLogs', JSON.stringify(logs));
    }

    function logout() {
      if (confirm('Are you sure you want to logout?')) {
        localStorage.removeItem('hospitalLoggedIn');
        localStorage.removeItem('hospitalName');
        window.location.href = '../index.html';
      }
    }
  </script>
</body>
</html>

